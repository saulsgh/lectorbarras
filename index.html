<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Escáner de Código de Barras</title>
    <script src="https://unpkg.com/quagga"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsqr/dist/jsQR.js"></script>
    <script src="https://unpkg.com/html5-qrcode"></script>
</head>
<body>
    <h2>Escáner de Código de Barras</h2>

    <!-- QuaggaJS -->
    <input type="text" id="barcodeInputQuagga" placeholder="Código QuaggaJS" readonly>
    <button onclick="startScannerQuagga()">Escanear con QuaggaJS</button>
    <video id="scannerQuagga" style="width: 100%; max-width: 400px; display: none;"></video>

    <!-- ZXing (jsQR) -->
    <input type="text" id="barcodeInputZXing" placeholder="Código ZXing" readonly>
    <button onclick="startScannerZXing()">Escanear con ZXing (jsQR)</button>
    <video id="scannerZXing" style="width: 100%; max-width: 400px; display: none;"></video>

    <!-- Html5QrcodeScanner -->
    <input type="text" id="barcodeInputHtml5" placeholder="Código Html5Qrcode" readonly>
    <button onclick="startScannerHtml5()">Escanear con Html5Qrcode</button>
    <div id="reader" style="width: 100%; max-width: 400px;"></div>

    <!-- BarcodeDetector API (Nativo) -->
    <input type="text" id="barcodeInputNative" placeholder="Código API Nativa" readonly>
    <button onclick="startScannerNative()">Escanear con BarcodeDetector</button>
    <video id="scannerNative" autoplay playsinline style="width: 100%; max-width: 400px; display: none;"></video>

    <script>
        // 1. Escáner con QuaggaJS
        function startScannerQuagga() {
            let inputField = document.getElementById("barcodeInputQuagga");
            let videoElement = document.getElementById("scannerQuagga");

            Quagga.init({
                inputStream: {
                    name: "Live",
                    type: "LiveStream",
                    target: videoElement,
                    constraints: { facingMode: "environment" }
                },
                decoder: { readers: ["code_128_reader", "ean_reader", "ean_8_reader", "upc_reader"] }
            }, function (err) {
                if (err) { console.error("Error:", err); return; }
                Quagga.start();
                videoElement.style.display = "block";
            });

            Quagga.onDetected(function (result) {
                inputField.value = result.codeResult.code;
                Quagga.stop();
                videoElement.style.display = "none";
            });
        }

        // 2. Escáner con ZXing (jsQR)
        function startScannerZXing() {
            let inputField = document.getElementById("barcodeInputZXing");
            let video = document.createElement("video");

            navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } })
                .then(stream => {
                    video.srcObject = stream;
                    video.setAttribute("playsinline", true);
                    video.play();
                    scanZXing(video, inputField, stream);
                });
        }

        function scanZXing(video, inputField, stream) {
            let canvas = document.createElement("canvas");
            let ctx = canvas.getContext("2d");

            function tick() {
                if (video.readyState === video.HAVE_ENOUGH_DATA) {
                    canvas.width = video.videoWidth;
                    canvas.height = video.videoHeight;
                    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
                    let imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                    let code = jsQR(imageData.data, imageData.width, imageData.height);
                    if (code) {
                        inputField.value = code.data;
                        stream.getTracks().forEach(track => track.stop());
                    } else {
                        requestAnimationFrame(tick);
                    }
                }
            }
            tick();
        }

        // 3. Escáner con Html5QrcodeScanner
        function startScannerHtml5() {
            let inputField = document.getElementById("barcodeInputHtml5");
            let scanner = new Html5Qrcode("reader");

            scanner.start(
                { facingMode: "environment" },
                { fps: 10, qrbox: 250 },
                (decodedText) => {
                    inputField.value = decodedText;
                    scanner.stop();
                },
                (errorMessage) => {
                    console.log("Error:", errorMessage);
                }
            );
        }

        // 4. Escáner con BarcodeDetector API Nativa
        async function startScannerNative() {
            if (!("BarcodeDetector" in window)) {
                alert("BarcodeDetector API no soportada en este navegador.");
                return;
            }

            let inputField = document.getElementById("barcodeInputNative");
            let video = document.getElementById("scannerNative");
            video.style.display = "block";

            let stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
            video.srcObject = stream;

            const barcodeDetector = new BarcodeDetector({ formats: ["code_128", "ean_13", "qr_code"] });

            function detectBarcode() {
                barcodeDetector.detect(video)
                    .then(barcodes => {
                        if (barcodes.length > 0) {
                            inputField.value = barcodes[0].rawValue;
                            stream.getTracks().forEach(track => track.stop());
                            video.style.display = "none";
                        } else {
                            requestAnimationFrame(detectBarcode);
                        }
                    })
                    .catch(err => console.error("Error detectando código:", err));
            }

            video.onloadedmetadata = () => detectBarcode();
        }
    </script>
</body>
</html>
